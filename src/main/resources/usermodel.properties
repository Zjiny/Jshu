user= \
select                                                                                                                  \
new.user_id,                                                                                                            \
new.nt,                                                                                                                 \
new.cd,                                                                                                                 \
new.se,                                                                                                                 \
new.pv,                                                                                                                 \
new.bro,                                                                                                                \
new.os,                                                                                                                 \
old.nt,                                                                                                                 \
old.cd,                                                                                                                 \
old.se,                                                                                                                 \
old.pv,                                                                                                                 \
old.bro,                                                                                                                \
old.os,                                                                                                                 \
origin.dt_7,                                                                                                            \
origin.dt_15,                                                                                                           \
origin.dt_30,                                                                                                           \
origin.dt_60,                                                                                                           \
origin.dt_90,                                                                                                           \
dws.dt_30,                                                                                                              \
dws.aver,                                                                                                               \
origin.last05,                                                                                                          \
origin.last67,                                                                                                          \
origin.last89,                                                                                                          \
origin.last1011,                                                                                                        \
origin.last1213,                                                                                                        \
origin.last1416,                                                                                                        \
origin.last1719,                                                                                                        \
origin.last1819,                                                                                                        \
origin.last2021,                                                                                                        \
origin.last2223,                                                                                                        \
dws.ipcount,                                                                                                            \
maxip.content,                                                                                                          \
dws1.ckcount,                                                                                                           \
maxcookie.content,                                                                                                      \
maxbrowser.content,                                                                                                     \
maxos.content,                                                                                                          \
app_new.nt,                                                                                                             \
app_new.ae,                                                                                                             \
app_new.os,                                                                                                             \
app_old.nt,                                                                                                             \
app_old.ae,                                                                                                             \
app_old.os,                                                                                                             \
app_old.ip,                                                                                                             \
app_origin.dt_7,                                                                                                        \
app_origin.dt_15,                                                                                                       \
app_origin.dt_30,                                                                                                       \
app_origin.dt_60,                                                                                                       \
app_origin.dt_90,                                                                                                       \
app_origin.last05,                                                                                                      \
app_origin.last67,                                                                                                      \
app_origin.last89,                                                                                                      \
app_origin.last1011,                                                                                                    \
app_origin.last1213,                                                                                                    \
app_origin.last1415,                                                                                                    \
app_origin.last1617,                                                                                                    \
app_origin.last1819,                                                                                                    \
app_origin.last2021,                                                                                                    \
app_origin.last2223,                                                                                                    \
sub1.uip,                                                                                                               \
sub1.pro,                                                                                                               \
sub1.ucy,                                                                                                               \
sub2.uip,                                                                                                               \
sub2.pro,                                                                                                               \
sub2.ucy                                                                                                                \
from                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
in_time nt,                                                                                                             \
cookie_id cd,                                                                                                           \
session_id se,                                                                                                          \
pv,                                                                                                                     \
browser_name bro,                                                                                                       \
visit_os os                                                                                                             \
from                                                                                                                    \
qfbap_dwd.dwd_user_pc_pv pv                                                                                             \
join                                                                                                                    \
    (                                                                                                                   \
        select                                                                                                          \
        from_unixtime(max(to_unix_timestamp(in_time)),'yyyy-MM-dd HH:mm:ss') nt                                         \
        from                                                                                                            \
        qfbap_dwd.dwd_user_pc_pv                                                                                        \
        group by                                                                                                        \
        user_id                                                                                                         \
    ) temp                                                                                                              \
on                                                                                                                      \
pv.in_time=temp.nt                                                                                                      \
) new                                                                                                                   \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
in_time nt,                                                                                                             \
cookie_id cd,                                                                                                           \
session_id se,                                                                                                          \
pv,                                                                                                                     \
browser_name bro,                                                                                                       \
visit_os os                                                                                                             \
from                                                                                                                    \
qfbap_dwd.dwd_user_pc_pv pv                                                                                             \
    join                                                                                                                \
    (                                                                                                                   \
        select                                                                                                          \
        from_unixtime(min(to_unix_timestamp(in_time)),'yyyy-MM-dd HH:mm:ss') nt                                         \
        from                                                                                                            \
        qfbap_dwd.dwd_user_pc_pv                                                                                        \
        group by                                                                                                        \
        user_id                                                                                                         \
    ) temp                                                                                                              \
    on                                                                                                                  \
pv.in_time=temp.nt                                                                                                      \
) old                                                                                                                   \
on                                                                                                                      \
new.user_id=old.user_id                                                                                                 \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
sum(case when to_date(in_time) >= date_sub('2019-07-10',7) then 1 end) as dt_7,                                         \
sum(case when to_date(in_time) >= date_sub('2019-07-10',15) then 1 end) as dt_15,                                       \
sum(case when to_date(in_time) >= date_sub('2019-07-10',30) then 1 end) as dt_30,                                       \
sum(case when to_date(in_time) >= date_sub('2019-07-10',60) then 1 end) as dt_60,                                       \
sum(case when to_date(in_time) >= date_sub('2019-07-10',90) then 1 end) as dt_90,                                       \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 0 and 5                                                                                           \
then 1                                                                                                                  \
end                                                                                                                     \
) as last05,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 6 and 7                                                                                           \
then 1                                                                                                                  \
end                                                                                                                     \
) as last67,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 8 and 9                                                                                           \
then 1                                                                                                                  \
end                                                                                                                     \
) as last89,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 10 and 11                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1011,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 12 and 13                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1213,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 14 and 16                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1416,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 17 and 19                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1719,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 18 and 19                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1819,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 20 and 21                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last2021,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(in_time) >= date_sub('2019-07-10',30)                                                                           \
and                                                                                                                     \
hour(in_time) between 22 and 23                                                                                         \
then 1                                                                                                                  \
end                                                                                                                     \
) as last2223                                                                                                           \
from                                                                                                                    \
qfbap_dwd.dwd_user_pc_pv                                                                                                \
group by                                                                                                                \
user_id                                                                                                                 \
) origin                                                                                                                \
on                                                                                                                      \
new.user_id=origin.user_id                                                                                              \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
sum(cnt) dt_30,                                                                                                         \
case when sum(cnt)>0 then round(sum(cnt)/30,3) end as aver,                                                             \
count(distinct content) ipcount                                                                                         \
from                                                                                                                    \
qfbap_dws.dws_user_visit_month1                                                                                         \
where TYPE = 'visit_ip'                                                                                                 \
group by                                                                                                                \
user_id                                                                                                                 \
) dws                                                                                                                   \
on                                                                                                                      \
new.user_id=dws.user_id                                                                                                 \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
count(distinct content) ckcount                                                                                         \
from                                                                                                                    \
qfbap_dws.dws_user_visit_month1                                                                                         \
where TYPE = 'cookie_id'                                                                                                \
group by                                                                                                                \
user_id                                                                                                                 \
) dws1                                                                                                                  \
on                                                                                                                      \
new.user_id=dws1.user_id                                                                                                \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
content                                                                                                                 \
from                                                                                                                    \
 (                                                                                                                      \
    select                                                                                                              \
    user_id,                                                                                                            \
    content,                                                                                                            \
    count(*),                                                                                                           \
    rank() over( partition by user_id,content order by count(*) desc) as rank                                           \
    from                                                                                                                \
    qfbap_dws.dws_user_visit_month1                                                                                     \
    where TYPE = 'visit_ip'                                                                                             \
    group by                                                                                                            \
    user_id,                                                                                                            \
    content                                                                                                             \
) iptemp                                                                                                                \
where iptemp.rank=1                                                                                                     \
) maxip                                                                                                                 \
on new.user_id=maxip.user_id                                                                                            \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
content                                                                                                                 \
from                                                                                                                    \
 (                                                                                                                      \
    select                                                                                                              \
    user_id,                                                                                                            \
    content,                                                                                                            \
    count(*),                                                                                                           \
    rank() over( partition by user_id,content order by count(*) desc) as rank                                           \
    from                                                                                                                \
    qfbap_dws.dws_user_visit_month1                                                                                     \
    where TYPE = 'cookie_id'                                                                                            \
    group by                                                                                                            \
    user_id,                                                                                                            \
    content                                                                                                             \
) cookietemp                                                                                                            \
where cookietemp.rank=1                                                                                                 \
) maxcookie                                                                                                             \
on new.user_id=maxcookie.user_id                                                                                        \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
content                                                                                                                 \
from                                                                                                                    \
 (                                                                                                                      \
    select                                                                                                              \
    user_id,                                                                                                            \
    content,                                                                                                            \
    count(*),                                                                                                           \
    rank() over( partition by user_id,content order by count(*) desc) as rank                                           \
    from                                                                                                                \
    qfbap_dws.dws_user_visit_month1                                                                                     \
    where TYPE = 'browser_name'                                                                                         \
    group by                                                                                                            \
    user_id,                                                                                                            \
    content                                                                                                             \
) browsertemp                                                                                                           \
where browsertemp.rank=1                                                                                                \
) maxbrowser                                                                                                            \
on new.user_id=maxbrowser.user_id                                                                                       \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
content                                                                                                                 \
from                                                                                                                    \
 (                                                                                                                      \
    select                                                                                                              \
    user_id,                                                                                                            \
    content,                                                                                                            \
    count(*),                                                                                                           \
    rank() over( partition by user_id,content order by count(*) desc) as rank                                           \
    from                                                                                                                \
    qfbap_dws.dws_user_visit_month1                                                                                     \
    where TYPE = 'visit_os'                                                                                             \
    group by                                                                                                            \
    user_id,                                                                                                            \
    content                                                                                                             \
) ostemp                                                                                                                \
where ostemp.rank=1                                                                                                     \
) maxos                                                                                                                 \
on new.user_id=maxos.user_id                                                                                            \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
log_time nt,                                                                                                            \
app_name ae,                                                                                                            \
visit_os os                                                                                                             \
from                                                                                                                    \
qfbap_dwd.dwd_user_app_pv pv                                                                                            \
    join                                                                                                                \
    (                                                                                                                   \
        select                                                                                                          \
        from_unixtime(max(to_unix_timestamp(log_time)),'yyyy-MM-dd HH:mm:ss') nt                                        \
        from                                                                                                            \
        qfbap_dwd.dwd_user_app_pv                                                                                       \
        group by                                                                                                        \
        user_id                                                                                                         \
    ) temp                                                                                                              \
    on                                                                                                                  \
    pv.log_time=temp.nt                                                                                                     \
) app_new                                                                                                               \
on                                                                                                                      \
app_new.user_id=new.user_id                                                                                             \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
log_time nt,                                                                                                            \
app_name ae,                                                                                                            \
visit_os os,                                                                                                            \
visit_ip ip                                                                                                             \
from                                                                                                                    \
qfbap_dwd.dwd_user_app_pv pv                                                                                            \
    join                                                                                                                \
    (                                                                                                                   \
        select                                                                                                          \
        from_unixtime(min(to_unix_timestamp(log_time)),'yyyy-MM-dd HH:mm:ss') nt                                        \
        from                                                                                                            \
        qfbap_dwd.dwd_user_app_pv                                                                                       \
        group by                                                                                                        \
        user_id                                                                                                         \
    ) temp                                                                                                              \
    on                                                                                                                      \
    pv.log_time=temp.nt                                                                                                     \
) app_old                                                                                                               \
on                                                                                                                      \
app_old.user_id=new.user_id                                                                                             \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
user_id,                                                                                                                \
sum(case when to_date(log_time) >= date_sub('2019-07-10',7) then 1 end) as dt_7,                                        \
sum(case when to_date(log_time) >= date_sub('2019-07-10',15) then 1 end) as dt_15,                                      \
sum(case when to_date(log_time) >= date_sub('2019-07-10',30) then 1 end) as dt_30,                                      \
sum(case when to_date(log_time) >= date_sub('2019-07-10',60) then 1 end) as dt_60,                                      \
sum(case when to_date(log_time) >= date_sub('2019-07-10',90) then 1 end) as dt_90,                                      \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 0 and 5                                                                                          \
then 1                                                                                                                  \
end                                                                                                                     \
) as last05,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 6 and 7                                                                                          \
then 1                                                                                                                  \
end                                                                                                                     \
) as last67,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 8 and 9                                                                                          \
then 1                                                                                                                  \
end                                                                                                                     \
) as last89,                                                                                                            \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 10 and 11                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1011,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 12 and 13                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1213,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 14 and 15                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1415,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 16 and 17                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1617,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 18 and 19                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last1819,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 20 and 21                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last2021,                                                                                                          \
sum(                                                                                                                    \
case when                                                                                                               \
to_date(log_time) >= date_sub('2019-07-10',30)                                                                          \
and                                                                                                                     \
hour(log_time) between 22 and 23                                                                                        \
then 1                                                                                                                  \
end                                                                                                                     \
) as last2223                                                                                                           \
from                                                                                                                    \
qfbap_dwd.dwd_user_app_pv                                                                                               \
group by                                                                                                                \
user_id                                                                                                                 \
) app_origin                                                                                                            \
on                                                                                                                      \
new.user_id=app_origin.user_id                                                                                          \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
app_union.id uid,                                                                                                       \
app_union.ip uip,                                                                                                       \
app_union.pro pro,                                                                                                      \
app_union.cy ucy                                                                                                        \
from                                                                                                                    \
    (                                                                                                                   \
    select                                                                                                              \
    user_id id,                                                                                                         \
    in_time t,                                                                                                          \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_pc_pv                                                                                            \
    union ALL                                                                                                           \
    select                                                                                                              \
    user_id id,                                                                                                         \
    log_time t,                                                                                                         \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_app_pv                                                                                           \
    ) app_union                                                                                                         \
join                                                                                                                    \
    (                                                                                                                   \
    select                                                                                                              \
    temp.id,                                                                                                            \
    from_unixtime(max(to_unix_timestamp(t)),'yyyy-MM-dd HH:mm:ss') nt                                                   \
    from                                                                                                                \
    (                                                                                                                   \
    select                                                                                                              \
    user_id id,                                                                                                         \
    in_time t,                                                                                                          \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_pc_pv                                                                                            \
    union ALL                                                                                                           \
    select                                                                                                              \
    user_id id,                                                                                                         \
    log_time t,                                                                                                         \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_app_pv                                                                                           \
    ) temp                                                                                                              \
    group by                                                                                                            \
    temp.id                                                                                                             \
    ) app_max                                                                                                           \
on                                                                                                                      \
    app_union.t=app_max.nt                                                                                              \
) sub1                                                                                                                  \
on                                                                                                                      \
new.user_id=sub1.uid                                                                                                    \
join                                                                                                                    \
(                                                                                                                       \
select                                                                                                                  \
app_union.id uid,                                                                                                       \
app_union.ip uip,                                                                                                       \
app_union.pro pro,                                                                                                      \
app_union.cy ucy                                                                                                        \
from                                                                                                                    \
    (                                                                                                                   \
    select                                                                                                              \
    user_id id,                                                                                                         \
    in_time t,                                                                                                          \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_pc_pv                                                                                            \
    union ALL                                                                                                           \
    select                                                                                                              \
    user_id id,                                                                                                         \
    log_time t,                                                                                                         \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_app_pv                                                                                           \
    ) app_union                                                                                                         \
join                                                                                                                    \
    (                                                                                                                   \
    select                                                                                                              \
    temp.id,                                                                                                            \
    from_unixtime(min(to_unix_timestamp(t)),'yyyy-MM-dd HH:mm:ss') nt                                                   \
    from                                                                                                                \
    (                                                                                                                   \
    select                                                                                                              \
    user_id id,                                                                                                         \
    in_time t,                                                                                                          \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_pc_pv                                                                                            \
    union ALL                                                                                                           \
    select                                                                                                              \
    user_id id,                                                                                                         \
    log_time t,                                                                                                         \
    visit_ip ip,                                                                                                        \
    province pro,                                                                                                       \
    city cy                                                                                                             \
    from                                                                                                                \
    qfbap_dwd.dwd_user_app_pv                                                                                           \
    ) temp                                                                                                              \
    group by                                                                                                            \
    temp.id                                                                                                             \
    ) app_min                                                                                                           \
on                                                                                                                      \
    app_union.t=app_min.nt                                                                                              \
) sub2                                                                                                                  \
on                                                                                                                      \
new.user_id=sub2.uid                                                                                                    